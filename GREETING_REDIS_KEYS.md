# Greeting Message - å¿«é€Ÿåƒè€ƒ

## ğŸ“Œ æ ¸å¿ƒé‚è¼¯

```
ç•¶ç”¨æˆ¶ç™¼é€è¨Šæ¯æ™‚ï¼š

1ï¸âƒ£ æª¢æŸ¥ Redis: {line_user_id}_lastest
   â”œâ”€ å­˜åœ¨ä¸” = ä»Šæ—¥ â†’ ä¸é¡¯ç¤ºå•å€™ âŒ
   â””â”€ ä¸å­˜åœ¨æˆ– â‰  ä»Šæ—¥ â†’ é€²å…¥æ­¥é©Ÿ 2

2ï¸âƒ£ æ›´æ–°è³‡æ–™åº« visitdate = ä»Šæ—¥

3ï¸âƒ£ æ¯”è¼ƒèˆŠçš„ visitdate æ˜¯å¦ â‰  ä»Šæ—¥
   â”œâ”€ = ä»Šæ—¥ â†’ ä¸é¡¯ç¤ºå•å€™ âŒ
   â””â”€ â‰  ä»Šæ—¥æˆ–NULL â†’ é¡¯ç¤ºå•å€™ âœ… 
      "è¦ªæ„›çš„æœƒå“¡{display_name}({id})æ‚¨å¥½!"

4ï¸âƒ£ å¯«å…¥ Redis: {line_user_id}_lastest = ä»Šæ—¥ï¼ˆTTL: 36å°æ™‚ï¼‰
```

---

## ğŸ”´ æ‡‰æ¸…é™¤çš„ Redis Key

### Key æ¨¡å¼
```
{line_user_id}_lastest
```

### è©³ç´°ä¿¡æ¯
| å±¬æ€§ | å€¼ |
|------|-----|
| **Key æ ¼å¼** | `{line_user_id}_lastest` |
| **Key å€¼** | æ—¥æœŸå­—ç¬¦ä¸²ï¼ˆå¦‚ `2025-12-16`ï¼‰ |
| **éæœŸæ™‚é–“** | 36 å°æ™‚ï¼ˆè‡ªå‹•å¤±æ•ˆï¼‰ |
| **ä½œç”¨** | å¿«é€Ÿåˆ¤æ–·ç”¨æˆ¶æ˜¯å¦å·²åœ¨ä»Šæ—¥è¨ªå• |
| **åˆªé™¤æ™‚æ©Ÿ** | æ¸¬è©¦ greeting message æ™‚ |

### æŸ¥çœ‹æ‰€æœ‰ç›¸é—œ Key
```bash
redis-cli KEYS "*_lastest"
```

### æ‰‹å‹•æ¸…é™¤æ–¹å¼
```bash
# æ¸…é™¤æ‰€æœ‰ latest æ¨™è¨˜
redis-cli EVAL "return redis.call('del', unpack(redis.call('keys', '*_lastest')))" 0

# æ¸…é™¤ç‰¹å®šç”¨æˆ¶
redis-cli DEL "U1234567890abcdef1234567890abcdef_lastest"
```

---

## ğŸŸ¦ æ¶‰åŠçš„è³‡æ–™åº«æ¬„ä½

### line_users è¡¨
```sql
CREATE TABLE line_users (
    id INT PRIMARY KEY AUTO_INCREMENT,        -- â† greeting ä½¿ç”¨é€™å€‹ id
    line_id VARCHAR(255) UNIQUE,              -- â† greeting ä½¿ç”¨é€™å€‹æŸ¥è©¢
    display_name VARCHAR(255),                -- â† greeting é¡¯ç¤ºé€™å€‹åå­—
    visitdate DATE,                           -- â† greeting æ¯”è¼ƒé€™å€‹æ—¥æœŸ
    ...
);
```

### visitdate çš„è§’è‰²
| æ“ä½œ | èªªæ˜ |
|------|------|
| **æ›´æ–°** | æ¯æ¬¡ç”¨æˆ¶è¨Šæ¯æ™‚æ›´æ–°ç‚ºä»Šæ—¥ |
| **è®€å–** | æ¯”è¼ƒèˆŠå€¼ï¼ˆæ›´æ–°å‰ï¼‰æ˜¯å¦ â‰  ä»Šæ—¥ |
| **åˆ¤æ–·** | è‹¥ â‰  ä»Šæ—¥æˆ– NULL â†’ é¡¯ç¤ºå•å€™ |
| **é‡è¨­** | ä¿®æ”¹ç‚ºæ˜¨å¤©ä¾†æ¸¬è©¦ greeting |

---

## ğŸ“‹ æ¸¬è©¦æ¸…é™¤æ¸…å–®

è¦è®“ greeting message å‡ºç¾ï¼Œéœ€è¦ï¼š

- [ ] **æ­¥é©Ÿ 1**ï¼šé‡è¨­è³‡æ–™åº« visitdate ç‚ºæ˜¨å¤©
  ```
  python clearredis.py
  é¸é … 6
  ```
  
- [ ] **æ­¥é©Ÿ 2**ï¼šæ¸…é™¤ Redis latest æ¨™è¨˜
  ```
  python clearredis.py
  é¸é … 7
  ```

- [ ] **é©—è­‰**ï¼šç”¨æˆ¶ç™¼é€è¨Šæ¯
  ```
  æ‡‰é¡¯ç¤ºï¼šè¦ªæ„›çš„æœƒå“¡{name}({id})æ‚¨å¥½!
  ```

- [ ] **ç¢ºèª Redis å·²æ›´æ–°**ï¼šç”¨æˆ¶å†æ¬¡ç™¼é€è¨Šæ¯
  ```
  æ‡‰ä¸é¡¯ç¤ºå•å€™ï¼ˆRedis latest å·²è¨˜éŒ„ä»Šæ—¥ï¼‰
  ```

---

## ğŸ”§ clearredis.py é¸é …å°ç…§è¡¨

| é¸é … | åŠŸèƒ½ | æ¸…é™¤å°è±¡ | å½±éŸ¿ |
|------|------|--------|------|
| **1** | åˆ—å‡ºæ‰€æœ‰ key | - | ç„¡ |
| **2** | æ¸…é™¤ä»Šå¤©çš„ç·©å­˜ | åŒ…å«æ—¥æœŸçš„æ‰€æœ‰ key | å»£æ³› |
| **3** | æ¸…é™¤æŒ‡å®šæ—¥æœŸç·©å­˜ | ç‰¹å®šæ—¥æœŸçš„ key | æŒ‡å®š |
| **4** | æ¸…é™¤æœ€è¿‘ 7 å¤©ç·©å­˜ | 7 å¤©å…§çš„æ‰€æœ‰ key | å»£æ³› |
| **5** | æ¸…é™¤ç‰¹å®šé¡å‹ç·©å­˜ | work/room/store/staffs | æŒ‡å®šé¡å‹ |
| **6** | é‡è¨­ visitdate ç‚ºæ˜¨å¤© | è³‡æ–™åº« visitdate | æ•¸æ“šåº« |
| **7** | æ¸…é™¤ Redis latest | `*_lastest` key | Redis |
| **8** | æ¸…é™¤æ‰€æœ‰ç·©å­˜ | æ‰€æœ‰ Redis key | å±éšªï¼ |

---

## âš ï¸ å¸¸è¦‹éŒ¯èª¤

### âŒ åªåŸ·è¡Œé¸é … 7ï¼ˆæ¸…é™¤ Redisï¼‰
- Redis latest è¢«æ¸…é™¤
- è³‡æ–™åº« visitdate ä»æ˜¯ä»Šæ—¥
- **çµæœ**ï¼šç”¨æˆ¶ç™»å…¥æ™‚ä»**ä¸**é¡¯ç¤ºå•å€™

### âŒ åªåŸ·è¡Œé¸é … 6ï¼ˆä¿®æ”¹è³‡æ–™åº«ï¼‰
- è³‡æ–™åº« visitdate æ”¹ç‚ºæ˜¨å¤©
- Redis latest ä»æœ‰è¨˜éŒ„
- **çµæœ**ï¼šç”¨æˆ¶ç™»å…¥æ™‚ä»**ä¸**é¡¯ç¤ºå•å€™

### âœ… åŒæ™‚åŸ·è¡Œé¸é … 6 å’Œ 7
- è³‡æ–™åº« visitdate = æ˜¨å¤©
- Redis latest = æ¸…ç©º
- **çµæœ**ï¼šç”¨æˆ¶ç™»å…¥æ™‚**æœƒ**é¡¯ç¤ºå•å€™ âœ“

---

## ğŸ“Š ç‹€æ…‹æª¢æŸ¥å‘½ä»¤

```bash
# æª¢æŸ¥ Redis latest æ˜¯å¦å­˜åœ¨
redis-cli KEYS "*_lastest"

# æª¢æŸ¥ç‰¹å®šç”¨æˆ¶çš„ visitdate
mysql -u root -p senspa_db
SELECT line_id, display_name, visitdate FROM line_users 
WHERE line_id = 'U1234567890abcdef1234567890abcdef';

# æŸ¥çœ‹ç”¨æˆ¶çš„æ‰€æœ‰ Redis key
redis-cli KEYS "U1234567890abcdef1234567890abcdef*"
```

---

## ğŸ“„ ç›¸é—œæ–‡ä»¶ä½ç½®

| æ–‡ä»¶ | æè¿° | é—œéµè¡Œ |
|------|------|--------|
| [modules/greeting.py](modules/greeting.py) | greeting æ ¸å¿ƒé‚è¼¯ | 16-87 |
| [core/common.py](core/common.py) | visitdate æ›´æ–°é‚è¼¯ | 2664-2700 |
| [api/routes/parse.py](api/routes/parse.py) | greeting å‘¼å«å…¥å£ | 100-120 |
| [clearredis.py](clearredis.py) | æ¸…é™¤å·¥å…· | å®Œæ•´ |
| [GREETING_MESSAGE_GUIDE.md](GREETING_MESSAGE_GUIDE.md) | è©³ç´°æŒ‡å— | å®Œæ•´ |

---

## ğŸ’¡ æœ€ä½³å¯¦è¸

1. **å®Œæ•´æ¸¬è©¦æµç¨‹**ï¼š
   ```bash
   python clearredis.py
   # é¸é … 6 â†’ é‡è¨­ visitdate
   # é¸é … 7 â†’ æ¸…é™¤ Redis
   # ç”¨æˆ¶ç™¼é€è¨Šæ¯ â†’ æ‡‰çœ‹åˆ°å•å€™
   ```

2. **æŸ¥çœ‹æ¸…é™¤çµæœ**ï¼š
   ```bash
   # é©—è­‰ Redis
   redis-cli KEYS "*_lastest"    # æ‡‰ç‚ºç©º
   
   # é©—è­‰è³‡æ–™åº«
   mysql> SELECT visitdate FROM line_users LIMIT 1;
   # æ‡‰ç‚ºæ˜¨å¤©æ—¥æœŸ
   ```

3. **é‡è¤‡æ¸¬è©¦**ï¼š
   ```bash
   # å†æ¬¡åŸ·è¡Œæ¸…é™¤æµç¨‹
   python clearredis.py
   # ç”¨æˆ¶ç™¼é€è¨Šæ¯ â†’ å†æ¬¡çœ‹åˆ°å•å€™
   ```

---

## ğŸ¯ ç¸½çµ

| è¦ç´  | è©³æƒ… |
|------|------|
| **Redis Key** | `{line_user_id}_lastest` |
| **è³‡æ–™åº«æ¬„ä½** | `line_users.visitdate` |
| **é¡¯ç¤ºæ¢ä»¶** | èˆŠ visitdate â‰  ä»Šæ—¥æˆ–ç‚º NULL |
| **æ¸…é™¤å·¥å…·** | `python clearredis.py` (é¸é … 6+7) |
| **é©—è­‰æ–¹æ³•** | ç”¨æˆ¶å†æ¬¡è¨Šæ¯æ™‚æ˜¯å¦é¡¯ç¤ºå•å€™ |
